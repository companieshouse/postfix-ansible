---
- name: Get IMDSv2 token
  ansible.builtin.uri:
    url: http://169.254.169.254/latest/api/token
    method: PUT
    headers:
      X-aws-ec2-metadata-token-ttl-seconds: "300"
    return_content: true
  register: instance_facts_imds_token
  changed_when: false

- name: Get instance ID
  ansible.builtin.uri:
    url: http://169.254.169.254/latest/meta-data/instance-id
    headers:
      X-aws-ec2-metadata-token: "{{ instance_facts_imds_token.content }}"
    return_content: true
  register: instance_facts_instance_id_result
  changed_when: false

- name: Get instance Region
  ansible.builtin.uri:
    url: http://169.254.169.254/latest/meta-data/placement/region
    headers:
      X-aws-ec2-metadata-token: "{{ instance_facts_imds_token.content }}"
    return_content: true
  register: instance_facts_instance_region_result
  changed_when: false

- name: Get Environment tag
  ansible.builtin.command: >
    aws ec2 describe-instances
    --instance-ids {{ instance_facts_instance_id_result.content }}
    --query "Reservations[*].Instances[*].Tags[?Key=='Environment'].Value"
    --output text
  register: instance_facts_aws_env
  changed_when: false
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
    AWS_DEFAULT_REGION: "{{ instance_facts_instance_region_result.content }}"

- name: Set environment facts
  ansible.builtin.set_fact:
    instance_facts_environment_name: "{{ instance_facts_aws_env.stdout }}"
    instance_facts_instance_id: "{{ instance_facts_instance_id_result.content }}"
    instance_facts_instance_region: "{{ instance_facts_instance_region_result.content }}"
